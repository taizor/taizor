<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BCP Supply Chain Dashboard (v8 Final Fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- pako (zlib åœ§ç¸®å±•é–‹) -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

  <style>
    /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f8; color: #333; }
    #map { width: 100%; height: 100%; }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    .tooltip {
      position: fixed; background: #fff; padding: 10px 14px; border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15); font-size: 12px; z-index: 1000;
      white-space: nowrap; border-left: 4px solid #667eea; pointer-events: none;
    }
    .tooltip-company { font-weight: 700; color: #4a5568; }
    .tooltip-plant { font-size: 11px; color: #718096; margin-top: 2px; }

    /* å·¦ãƒ‘ãƒãƒ« */
    .control-panel {
      position: absolute; top: 12px; left: 12px; background: #fff;
      padding: 16px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 400; width: 380px; max-height: calc(100vh - 24px); overflow-y: auto; font-size: 13px;
    }
    .control-panel h3 { color: #2d3748; font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }

    .stat-row { display: flex; justify-content: space-between; margin: 6px 0; padding: 4px 0; border-bottom: 1px solid #f7fafc; font-size: 12px; }
    .stat-value { font-weight: 700; color: #5a67d8; }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .section-title { font-weight: 700; color: #fff; margin-top: 20px; margin-bottom: 10px; padding: 6px 10px; border-radius: 4px; font-size: 12px; letter-spacing: 0.05em; }
    .section-analysis { background: linear-gradient(135deg, #00c853, #009624); }
    .section-contact  { background: linear-gradient(135deg, #e53e3e, #c53030); }
    .section-search   { background: linear-gradient(135deg, #667eea, #764ba2); }
    .section-marker   { background: linear-gradient(135deg, #36d1dc, #5b86e5); }
    .section-link     { background: linear-gradient(135deg, #f093fb, #f5576c); }

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
    .search-container { display: flex; gap: 6px; margin-bottom: 10px; }
    .search-container input { flex: 1; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; }
    .search-container button { padding: 8px 14px; background: #5a67d8; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }

    /* æ¤œç´¢çµæœãƒªã‚¹ãƒˆ */
    .plant-list { background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; max-height: 180px; overflow-y: auto; margin: 8px 0; }
    .plant-item { padding: 8px 10px; border-bottom: 1px solid #edf2f7; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .plant-item:hover { background: #ebf4ff; }
    
    .risk-badge { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

    /* åˆ†ææƒ…å ±ãƒ‘ãƒãƒ« */
    .analysis-info { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px; display: none; }
    .analysis-info.show { display: block; }

    /* Tieråˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .tier-section { background: #fff; border: 1px solid #cbd5e0; border-radius: 6px; margin: 10px 0; padding: 10px; display: none; }
    .tier-section.show { display: block; }
    .tier-title { font-weight: 700; color: #2d3748; font-size: 12px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #5a67d8; }

    /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé€£çµ¡å…ˆï¼‰ */
    .contact-section { background: #fff5f5; border: 2px solid #fc8181; border-radius: 6px; margin: 10px 0; padding: 10px; display: none; }
    .contact-section.show { display: block; }

    /* ãƒ«ãƒ¼ãƒˆé¸æŠä¸­è¡¨ç¤º */
    .route-active-msg {
        background: #ebf8ff; border: 2px solid #3182ce; color: #2b6cb0;
        padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;
        display: none; align-items: center; justify-content: space-between;
        font-weight: 600;
    }
    .route-active-msg.show { display: flex; }
    .btn-clear-route {
        background: #3182ce; color: #fff; border: none; padding: 6px 12px;
        border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 8px;
    }

    /* ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆé …ç›® */
    .tier-item { padding: 8px; margin: 4px 0; background: #fff; border: 1px solid #e2e8f0; border-left: 3px solid #ecc94b; border-radius: 4px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .tier-item:hover { background-color: #f0f7ff; }
    .tier-company { font-weight: 700; color: #2d3748; }
    .tier-plant { font-size: 10px; color: #718096; }
    .tier-risk-tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; color: #fff; font-weight: 600; }

    /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ */
    .tab-buttons { display: flex; gap: 6px; margin: 10px 0; }
    .tab-btn { flex: 1; padding: 8px; background: #edf2f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 700; color: #4a5568; }
    .tab-btn.active { background: #5a67d8; color: #fff; }

    /* ãƒ•ã‚£ãƒ«ã‚¿ */
    .filter-item { display: flex; align-items: center; margin: 6px 0; gap: 8px; font-size: 12px; color: #4a5568; }
    .indicator { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #fff; box-shadow: 0 0 0 1px #cbd5e0; }

    /* ãƒœã‚¿ãƒ³ */
    .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
    .btn { padding: 10px; background: #5a67d8; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; width: 100%; transition: background 0.2s; }
    .btn:hover { background: #4c51bf; }
    .btn.secondary { background: #a0aec0; }
    .btn.secondary:hover { background: #718096; }
    
    /* CSVä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆç·‘ï¼‰ */
    .btn-download {
      background: #2f855a; color: #fff; border: none; padding: 6px 14px; 
      border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;
      margin-right: 8px; display: inline-flex; align-items: center; gap: 4px;
    }
    .btn-download:hover { background: #276749; }

    /* åœ°å›³è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆé’ï¼‰ */
    .btn-map-view {
      background: #3182ce; color: #fff; border: none; padding: 4px 8px;
      border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 10px;
    }
    .btn-map-view:hover { background: #2c5282; }

    /* å‡¡ä¾‹ */
    .legend { position: absolute; bottom: 20px; right: 20px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 400; font-size: 11px; }
    .legend-title { font-weight: 700; margin-bottom: 8px; font-size: 12px; }
    .legend-item { display: flex; align-items: center; margin: 4px 0; gap: 6px; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .overlay.hide { display: none; }
    .modal { background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 400px; width: 90%; text-align: center; }
    .error-msg { color: #e53e3e; font-weight: 600; margin-top: 8px; }

    /* ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚¢ */
    .supply-chain-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; overflow-y: auto; }
    .supply-chain-viewer.show { display: block; }
    .supply-chain-panel { background: #fff; border-radius: 8px; max-width: 1200px; margin: 40px auto; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding-bottom: 20px; }
    .supply-chain-header { padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f7fafc; border-radius: 8px 8px 0 0; }
    .supply-chain-header h2 { color: #2d3748; font-size: 16px; margin: 0; }
    .supply-chain-content { padding: 20px; max-height: 70vh; overflow-y: auto; }

    /* ãƒ•ãƒ­ãƒ¼å›³ */
    .chain-item { margin-bottom: 24px; padding: 12px; background: #fff; border: 1px solid #e2e8f0; border-left: 4px solid #5a67d8; border-radius: 4px; }
    .chain-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .chain-number { display: inline-block; background: #5a67d8; color: #fff; padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 11px; }
    .flow-diagram { display: flex; align-items: center; gap: 8px; overflow-x: auto; padding: 10px; background: #f8fafc; border-radius: 6px; }
    .flow-node { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; }
    .flow-box { background: #fff; border: 2px solid #a0aec0; border-radius: 6px; padding: 6px 10px; min-width: 120px; text-align: center; font-size: 11px; font-weight: 700; color: #2d3748; }
    .flow-box.target { background: #f0fff4; color: #2f855a; border-color: #48bb78; }
    .flow-arrow { font-size: 16px; color: #cbd5e0; flex-shrink: 0; }
    .flow-company { font-size: 10px; color: #718096; margin-top: 2px; }
    
    .risk-badge-sm { display: inline-block; font-size: 9px; padding: 1px 5px; border-radius: 3px; color: #fff; }
    .risk-critical { background: #e53e3e; }
    .risk-high     { background: #dd6b20; }
    .risk-medium   { background: #38a169; }
    .risk-low      { background: #3182ce; }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading" class="overlay">
    <div class="modal">
      <h4 style="color:#5a67d8; margin-bottom:10px;">â³ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</h4>
      <p style="font-size: 12px; color: #666;">åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ã—ã¦ã„ã¾ã™</p>
    </div>
  </div>

  <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
  <div id="error" class="overlay hide">
    <div class="modal">
      <h4>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
      <p id="error-msg" class="error-msg"></p>
    </div>
  </div>

  <!-- å·¦ãƒ‘ãƒãƒ« -->
  <div class="control-panel">
    <h3>âš ï¸ BCPåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
    <div id="data-status" style="font-size:11px; color:#2d3748; background:#ebf8ff; border:1px solid #bee3f8; padding:6px 8px; border-radius:4px; margin-bottom:10px;">
      â³ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
    </div>

    <div class="stat-row">
      <span>å…¨æ‹ ç‚¹æ•°:</span>
      <span class="stat-value" id="stat-plants">0</span>
    </div>
    <div class="stat-row">
      <span>è¡¨ç¤ºä¸­ãƒãƒ¼ã‚«ãƒ¼:</span>
      <span class="stat-value" id="stat-visible-markers">0</span>
    </div>

    <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-title section-search">ğŸ” ä¼æ¥­æ¤œç´¢</div>
    <div class="search-container">
      <input
        type="text"
        id="search-company"
        placeholder="ä¼šç¤¾åã‚’å…¥åŠ›..."
        onkeyup="if(event.key==='Enter'){ app.searchCompany(); }"
      />
      <button onclick="app.searchCompany()">æ¤œç´¢</button>
    </div>

    <!-- æ¤œç´¢çµæœãƒªã‚¹ãƒˆ -->
    <div id="plant-list-container" style="display: none;">
      <div style="font-size: 11px; font-weight: 600; margin: 8px 0; padding: 6px; background: #ebf8ff; border-radius: 4px; color:#2c5282;">
        ğŸ“ æ¤œç´¢çµæœ: <span id="plant-count">0</span>ä»¶
      </div>
      <div id="plant-list" class="plant-list"></div>
      <div style="font-size: 10px; color: #718096; margin-top: 4px; padding: 4px;">
        ğŸ’¡ æ‹ ç‚¹ã‚’é¸æŠã—ã¦è©³ç´°åˆ†æã‚’é–‹å§‹ã—ã¾ã™
      </div>
    </div>

    <!-- åˆ†æå¯¾è±¡ï¼ˆé¸æŠä¼æ¥­ï¼‰ -->
    <div class="section-title section-analysis">ğŸ¯ åˆ†æå¯¾è±¡ãƒ»é¸æŠæ‹ ç‚¹</div>
    <div id="analysis-info" class="analysis-info">
      <div><strong id="analysis-company-strong" style="font-size:14px; color:#2d3748;"></strong></div>
      <div style="margin-top: 2px;">æ‹ ç‚¹: <span id="plant-name-span"></span></div>
      <div style="margin-top: 2px; font-size:11px;">ãƒªã‚¹ã‚¯: <span id="tierN-risk" style="font-weight:700;"></span></div>
      
      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #cbd5e0; display:flex; justify-content:space-between; text-align:center;">
        <div style="flex:1;">
          <div style="font-size:10px; color:#718096;">ä¾›çµ¦å…ƒ (ä¸Šæµ)</div>
          <div style="font-size:16px; font-weight:700; color:#5a67d8;" id="upstream-count">0</div>
        </div>
        <div style="width:1px; background:#e2e8f0;"></div>
        <div style="flex:1;">
          <div style="font-size:10px; color:#718096;">ä¾›çµ¦å…ˆ (ä¸‹æµ)</div>
          <div style="font-size:16px; font-weight:700; color:#38a169;" id="downstream-count">0</div>
        </div>
      </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒˆé¸æŠä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="route-active-msg" class="route-active-msg">
       <span>ğŸ—ºï¸ <span id="active-route-name">ãƒ«ãƒ¼ãƒˆ</span> ã‚’å¼·èª¿è¡¨ç¤ºä¸­</span>
       <button class="btn-clear-route" onclick="app.clearChainSelection()">è¡¨ç¤ºè§£é™¤</button>
    </div>

    <!-- é€£çµ¡ã™ã¹ãTier1ãƒªã‚¹ãƒˆ -->
    <div id="contact-tier1-section" class="contact-section">
      <div style="font-weight:700; font-size:12px; color:#c53030; margin-bottom:6px;">
        ğŸ“ ã€è‡³æ€¥é€£çµ¡ã€‘ä¸€æ¬¡ä»•å…¥å…ˆ (Tier 1)
      </div>
      <div style="font-size:10px; color:#555; margin-bottom:6px;">
        ã“ã®æ‹ ç‚¹è¢«ç½ã«ã‚ˆã‚‹å½±éŸ¿ã‚’ç¢ºèªã™ã¹ãã€ä¸‰æ¡œå·¥æ¥­ã®ç›´æ¥ä»•å…¥å…ˆã§ã™ã€‚
      </div>
      <div id="contact-tier1-list"></div>
    </div>

    <!-- ä¾›çµ¦å…ˆï¼ˆä¸‹æµï¼‰ãƒªã‚¹ãƒˆ -->
    <div id="downstream-section" class="tier-section">
      <div class="tier-title" style="border-bottom-color: #38a169; color:#2f855a;">ã€ä¾›çµ¦å…ˆã€‘ç´å…¥å…ˆãƒ»é¡§å®¢ (Downstream)</div>
      <div style="font-size:10px; color:#718096; margin-bottom:6px;">
        â€» åˆ†æå¯¾è±¡ï¼ˆä¸Šè¨˜ï¼‰ãŒç´å…¥ã—ã¦ã„ã‚‹ä¼æ¥­
      </div>
      <div id="downstream-list"></div>
    </div>

    <!-- ä¾›çµ¦å…ƒï¼ˆä¸Šæµï¼‰ãƒªã‚¹ãƒˆ -->
    <div id="tier1-section" class="tier-section">
      <div class="tier-title">ã€ä¾›çµ¦å…ƒã€‘ç›´æ¥ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ (Upstream)</div>
      <div style="font-size:10px; color:#718096; margin-bottom:6px;">
        â€» åˆ†æå¯¾è±¡ï¼ˆä¸Šè¨˜ï¼‰ã¸ç´å…¥ã—ã¦ã„ã‚‹ä¼æ¥­
      </div>
      <div id="tier1-list"></div>
    </div>

    <!-- è©³ç´°åˆ†æãƒœã‚¿ãƒ³ -->
    <div class="tab-buttons" id="tab-buttons" style="display: none;">
      <button class="tab-btn active" onclick="app.showSupplyChainTab('flow')">ğŸ”€ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ ãƒ•ãƒ­ãƒ¼</button>
      <button class="tab-btn" onclick="app.showSupplyChainTab('table')">ğŸ“‹ è©³ç´°ãƒªã‚¹ãƒˆ</button>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š -->
    <div class="section-title section-marker">ğŸ“ è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿</div>
    
    <div style="margin-bottom:8px;"><strong>ãƒãƒ¼ã‚«ãƒ¼ (æ‹ ç‚¹)</strong></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
      <div class="filter-item">
        <input type="checkbox" id="filter-marker-critical" checked onchange="app.updateVisibility()" />
        <label for="filter-marker-critical"><div class="indicator" style="background:#e53e3e;"></div> CRITICAL</label>
      </div>
      <div class="filter-item">
        <input type="checkbox" id="filter-marker-high" checked onchange="app.updateVisibility()" />
        <label for="filter-marker-high"><div class="indicator" style="background:#dd6b20;"></div> HIGH</label>
      </div>
      <div class="filter-item">
        <input type="checkbox" id="filter-marker-medium" checked onchange="app.updateVisibility()" />
        <label for="filter-marker-medium"><div class="indicator" style="background:#38a169;"></div> MEDIUM</label>
      </div>
      <div class="filter-item">
        <input type="checkbox" id="filter-marker-low" checked onchange="app.updateVisibility()" />
        <label for="filter-marker-low"><div class="indicator" style="background:#3182ce;"></div> LOW</label>
      </div>
    </div>

    <div style="margin:10px 0 8px;"><strong>ãƒªãƒ³ã‚¯ (ä¾›çµ¦ç¶²)</strong></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
      <div class="filter-item">
        <input type="checkbox" id="filter-link-critical" checked onchange="app.updateVisibility()" />
        <label for="filter-link-critical">CRITICAL</label>
      </div>
      <div class="filter-item">
        <input type="checkbox" id="filter-link-high" checked onchange="app.updateVisibility()" />
        <label for="filter-link-high">HIGH</label>
      </div>
      <div class="filter-item">
        <input type="checkbox" id="filter-link-medium" checked onchange="app.updateVisibility()" />
        <label for="filter-link-medium">MEDIUM</label>
      </div>
      <div class="filter-item">
        <input type="checkbox" id="filter-link-low" checked onchange="app.updateVisibility()" />
        <label for="filter-link-low">LOW</label>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn" onclick="app.fitAllMarkers()">ğŸŒ å…¨ä½“ã‚’è¡¨ç¤º</button>
      <button class="btn secondary" onclick="app.clearAnalysis()">âœ– åˆ†æã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- å‡¡ä¾‹ -->
  <div class="legend">
    <div class="legend-title">ğŸ“Š ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«</div>
    <div class="legend-item"><div class="indicator" style="background:#e53e3e;"></div><span>CRITICAL</span></div>
    <div class="legend-item"><div class="indicator" style="background:#dd6b20;"></div><span>HIGH</span></div>
    <div class="legend-item"><div class="indicator" style="background:#38a169;"></div><span>MEDIUM</span></div>
    <div class="legend-item"><div class="indicator" style="background:#3182ce;"></div><span>LOW</span></div>
  </div>

  <!-- å¤šæ®µéšã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚¢ -->
  <div id="supply-chain-viewer" class="supply-chain-viewer">
    <div class="supply-chain-panel">
      <div class="supply-chain-header">
        <h2>ğŸ“Š ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³åˆ†æ (<span id="trace-direction-label">æ–¹å‘ä¸æ˜</span>) - <span id="sc-title-span"></span></h2>
        <div>
          <button class="btn-download" onclick="app.downloadCSV()">ğŸ’¾ CSVä¿å­˜</button>
          <button onclick="app.closeSupplyChainViewer()" style="background:#a0aec0; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">âœ– é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div class="supply-chain-content">
        <div id="flow-tab">
          <div id="flow-chains"></div>
        </div>
        <div id="table-tab" style="display:none;">
          <div id="table-chains"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Python ã‹ã‚‰ç½®æ›ã•ã‚Œã‚‹åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ (ç©ºã®å ´åˆã¯ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
    const COMPRESSED_GEOJSON = "COMPRESSEDGEOJSONHERE";
    const COMPRESSED_LINKS = "COMPRESSEDLINKSHERE";
    const COMPRESSED_UPSTREAM = "COMPRESSEDUPSTREAMHERE";
    const COMPRESSED_DOWNSTREAM = "COMPRESSEDDOWNSTREAMHERE";

    // ãƒ‡ãƒ¢ç”¨åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ (zlib + base64)
    const DEFAULT_COMPRESSED_GEOJSON = "eJytkm9LwkAcx9+K7LGMdDqzZ2F/HChFFD0IkaFXjeZu3M5AxAfRgyiVhEiTzqM4g70KPOHR8HD0yCzgYGkiGv1nmb6nNcf42W1bZRizrcxNc5Dcw6mM5S1wCMe4Xx4+SSNDhzNGhtVLNMY1UZnOeTHPiPF80JQ2wQUlxFJwh2A97KQxCqlQOpccF47r/RYq7pj+IFoBRwEkQieckOjtGAxiNQeYBZqvL0vfiQMFe+UeyUhxg3jkZnJ5psHbfsygcjok5t11Rxe2K/9uyU8m+P/Xw3+qfP2b4xG0/49HBIcN5zudIPG0BfS6l1Jm2NmJr7iBsrX/skCh+Nx+oF7V3xSx6P+GciUGBCy4BzKW5fzAi2vjHBBANQC8sJfQ=";
    const DEFAULT_COMPRESSED_LINKS = "eJyrVnIO8gzxdHb0UbJSiI7VUVDy8HT3ALGrlYrzS4uSU0FsQ2NLPUMdBWMzUxOAkMLcwrLUhMLOoBygXWdjJqYlIDaxPo1QO4MTK1eH5Bga1EFAAvpjDS";
    const DEFAULT_COMPRESSED_UPSTREAM = "eJyrVjJUslKINtJRMI7VUVAyAnFADGMYwwTEMASxTCGsWgAUJgrp";
    const DEFAULT_COMPRESSED_DOWNSTREAM = "eJyrVjJUslKINtFRMI3VUVAyAnEMQSxjOMsExAIxTMGMWgAUXArt";

    const CONFIG = {
      LINK_STYLES: {
        CRITICAL: { color: "#e53e3e", weight: 2.5, opacity: 0.8 },
        HIGH:     { color: "#dd6b20", weight: 2, opacity: 0.6 },
        MEDIUM:   { color: "#38a169", weight: 1.5, opacity: 0.4 },
        LOW:      { color: "#3182ce", weight: 1, opacity: 0.2 },
      }
    };

    const app = {
      state: {
        geoJsonData: null,
        linksData: null,
        upstreamData: null,
        downstreamData: null,
        sanohTier1Set: null,
        map: null,
        markers: {},
        links: { CRITICAL: [], HIGH: [], MEDIUM: [], LOW: [] },
        companyPlants: [],
        currentChains: [],      
        currentTraceType: "",   
        currentTargetName: "",
        relatedNodeIds: new Set(),
        activeChainArray: null, // å˜ä¸€ãƒ«ãƒ¼ãƒˆé¸æŠç”¨ï¼ˆé…åˆ—ã§é †åºä¿æŒï¼‰
        coordToIdMap: {}, 
        featureById: {}, // IDã‹ã‚‰Featureã¸ã®é«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹ç”¨
        routeLayerGroup: null, // ãƒ«ãƒ¼ãƒˆæç”»å°‚ç”¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
      },

      decompressData(compressed) {
        try {
          if (!compressed || compressed.includes("COMPRESSED")) return null;
          const binary = atob(compressed);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          const decompressed = pako.inflate(bytes, { to: "string" });
          const sanitized = decompressed.replace(/\bNaN\b/g, "null");
          return JSON.parse(sanitized);
        } catch (e) {
          throw new Error("ãƒ‡ãƒ¼ã‚¿å±•é–‹å¤±æ•—: " + e.message);
        }
      },

      initData() {
        try {
          const geo = this.decompressData(COMPRESSED_GEOJSON) || this.decompressData(DEFAULT_COMPRESSED_GEOJSON);
          const linksByRisk = this.decompressData(COMPRESSED_LINKS) || this.decompressData(DEFAULT_COMPRESSED_LINKS);
          const upstream = this.decompressData(COMPRESSED_UPSTREAM) || this.decompressData(DEFAULT_COMPRESSED_UPSTREAM);
          const downstream = this.decompressData(COMPRESSED_DOWNSTREAM) || this.decompressData(DEFAULT_COMPRESSED_DOWNSTREAM);

          if (!geo) throw new Error("ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");

          this.state.geoJsonData = geo;
          this.state.linksData = linksByRisk;
          this.state.upstreamData = upstream;
          this.state.downstreamData = downstream;
          const dataStatus = document.getElementById("data-status");
          const usedFallback = [COMPRESSED_GEOJSON, COMPRESSED_LINKS, COMPRESSED_UPSTREAM, COMPRESSED_DOWNSTREAM].some(v => v.includes("COMPRESSED"));
          dataStatus.textContent = usedFallback ? "ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (è‡ªå‹•è£œå®Œ)" : "å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
          dataStatus.style.background = usedFallback ? "#fefcbf" : "#e6fffa";
          dataStatus.style.borderColor = usedFallback ? "#faf089" : "#b2f5ea";

          // IDã‹ã‚‰Featureã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ä½œæˆ
          geo.features.forEach(f => {
              this.state.featureById[f.properties.id] = f;
          });
          
          // åº§æ¨™ -> ID ãƒãƒƒãƒ”ãƒ³ã‚° (ç²¾åº¦ç·©å’Œ: å°æ•°ç‚¹4æ¡ã§ä¸¸ã‚ã‚‹)
          const roundCoord = (val) => val.toFixed(4);
          geo.features.forEach(f => {
              const [lon, lat] = f.geometry.coordinates;
              const key = `${roundCoord(lat)},${roundCoord(lon)}`;
              this.state.coordToIdMap[key] = f.properties.id;
          });

          // ä¸‰æ¡œå·¥æ¥­ã®ä¸€æ¬¡ä»•å…¥å…ˆï¼ˆTier1ï¼‰ã‚»ãƒƒãƒˆæ§‹ç¯‰
          const sanohTier1Set = new Set();
          (geo.features || []).forEach(f => {
            if (f.properties.is_sanoh_tier1) {
              sanohTier1Set.add(Number(f.properties.id));
            }
          });
          this.state.sanohTier1Set = sanohTier1Set;

          this.initMap();
          this.updateStats();
          this.fitAllMarkers();

          // ãƒãƒƒãƒ—ç”Ÿæˆå¾Œã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ 
          this.state.routeLayerGroup = L.layerGroup().addTo(this.state.map);

          document.getElementById("loading").classList.add("hide");
        } catch (e) {
          console.error(e);
          document.getElementById("error-msg").textContent = e.message;
          document.getElementById("error").classList.remove("hide");
          document.getElementById("loading").classList.add("hide");
        }
      },

      initMap() {
        this.state.map = L.map("map", { center: [36.0, 138.0], zoom: 5, preferCanvas: true });
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18, attribution: "&copy; OpenStreetMap contributors" }).addTo(this.state.map);
        this.initMarkers();
        this.initLinks();
      },

      getRiskColor(risk) {
        switch (risk) {
          case "CRITICAL": return "#e53e3e";
          case "HIGH":     return "#dd6b20";
          case "MEDIUM":   return "#38a169";
          default:         return "#3182ce";
        }
      },

      initMarkers() {
        const features = this.state.geoJsonData.features || [];
        const tooltip = L.DomUtil.create("div", "tooltip");
        document.body.appendChild(tooltip);

        features.forEach(f => {
          const p = f.properties;
          const [lon, lat] = f.geometry.coordinates;
          if (!isFinite(lat) || !isFinite(lon)) return;

          const color = this.getRiskColor(p.risklevel);
          const marker = L.circleMarker([lat, lon], { radius: 5, fillColor: color, color: "#fff", weight: 1, fillOpacity: 0.9 });
          marker.addTo(this.state.map);
          this.state.markers[p.id] = marker;

          marker.on("click", () => { this.analyzePlant(p.id); });
          marker.on("mouseover", (e) => {
            tooltip.innerHTML = `<div class="tooltip-company">${p.company}</div><div class="tooltip-plant">${p.plant}</div><div style="font-size:10px; color:${color}; margin-top:2px;">${p.risklevel}</div>`;
            tooltip.style.left = (e.originalEvent.clientX + 12) + "px";
            tooltip.style.top  = (e.originalEvent.clientY + 12) + "px";
            tooltip.style.display = "block";
          });
          marker.on("mouseout", () => { tooltip.style.display = "none"; });
        });
      },

      initLinks() {
        const linksByRisk = this.state.linksData || {};
        const roundCoord = (val) => val.toFixed(4);
        
        ["CRITICAL", "HIGH", "MEDIUM", "LOW"].forEach(risk => {
          const style = CONFIG.LINK_STYLES[risk];
          const arr = linksByRisk[risk] || [];
          arr.forEach(link => {
            const [slon, slat] = link.source;
            const [tlon, tlat] = link.target;
            if (!isFinite(slat) || !isFinite(slon) || !isFinite(tlat) || !isFinite(tlon)) return;

            // ãƒªãƒ³ã‚¯ã®å§‹ç‚¹ãƒ»çµ‚ç‚¹IDã‚’ç‰¹å®š
            const srcKey = `${roundCoord(slat)},${roundCoord(slon)}`;
            const tgtKey = `${roundCoord(tlat)},${roundCoord(tlon)}`;
            const srcId = this.state.coordToIdMap[srcKey];
            const tgtId = this.state.coordToIdMap[tgtKey];

            const line = L.polyline([[slat, slon], [tlat, tlon]], style);
            line.addTo(this.state.map);
            this.state.links[risk].push({ line, meta: link, risk, srcId, tgtId });
          });
        });
        this.updateVisibility();
      },

      updateStats() {
        const total = (this.state.geoJsonData.features || []).length;
        document.getElementById("stat-plants").textContent = total;
        this.updateVisibility();
      },

      fitAllMarkers() {
        const markers = Object.values(this.state.markers);
        if (!markers.length) return;
        const group = L.featureGroup(markers);
        this.state.map.fitBounds(group.getBounds().pad(0.1));
      },

      clearAnalysis() {
        this.state.selectedPlantId = null;
        this.state.relatedNodeIds.clear();
        this.clearChainSelection(); // å˜ä¸€ãƒ«ãƒ¼ãƒˆé¸æŠã‚‚ã‚¯ãƒªã‚¢
        
        Object.values(this.state.markers).forEach(m => m.setStyle({ radius: 5, weight: 1 }));
        document.getElementById("analysis-info").classList.remove("show");
        document.getElementById("tier1-section").classList.remove("show");
        document.getElementById("downstream-section").classList.remove("show");
        document.getElementById("contact-tier1-section").classList.remove("show");
        document.getElementById("tab-buttons").style.display = "none";
        
        this.updateVisibility();
      },

      // å˜ä¸€ãƒ«ãƒ¼ãƒˆé¸æŠã®è§£é™¤
      clearChainSelection() {
        this.state.activeChainArray = null;
        if (this.state.routeLayerGroup) {
            this.state.routeLayerGroup.clearLayers(); // ãƒ«ãƒ¼ãƒˆç·šã‚’æ¶ˆã™
        }
        document.getElementById("route-active-msg").classList.remove("show");
        this.updateVisibility();
      },

      // å˜ä¸€ãƒ«ãƒ¼ãƒˆã®é¸æŠãƒ»è¡¨ç¤ºï¼ˆâ˜…ãƒ­ã‚¸ãƒƒã‚¯åˆ·æ–°ï¼‰
      showChainOnMap(chainIndex) {
        if (!this.state.currentChains || !this.state.currentChains[chainIndex]) return;
        
        const chain = this.state.currentChains[chainIndex];
        // è¡¨ç¤ºé †åºã‚’ [Start] -> [End] ã«çµ±ä¸€
        this.state.activeChainArray = this.state.currentTraceType.includes("upstream") ? [...chain].reverse() : chain;

        document.getElementById("active-route-name").textContent = `ãƒ«ãƒ¼ãƒˆ ${chainIndex + 1}`;
        document.getElementById("route-active-msg").classList.add("show");
        
        this.closeSupplyChainViewer();
        
        // 1. æ—¢å­˜ã®ãƒªãƒ³ã‚¯è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆåŸºæœ¬éš ã™ï¼‰
        this.updateVisibility();
        
        // 2. ãƒ«ãƒ¼ãƒˆå°‚ç”¨ã®ç·šã‚’å¼•ã (ID -> åº§æ¨™)
        this.state.routeLayerGroup.clearLayers();
        const latlngs = [];
        
        this.state.activeChainArray.forEach(id => {
            const f = this.state.featureById[Number(id)];
            if (f) {
                const [lon, lat] = f.geometry.coordinates;
                latlngs.push([lat, lon]);
            }
        });

        // ãƒãƒªãƒ©ã‚¤ãƒ³ã‚’æç”» (å¤ªã•5px, é’è‰²)
        if (latlngs.length > 1) {
            L.polyline(latlngs, {
                color: "#3182ce",
                weight: 5,
                opacity: 0.9,
                lineCap: 'round'
            }).addTo(this.state.routeLayerGroup);
        }
        
        // ãƒ«ãƒ¼ãƒˆå…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«ã‚ºãƒ¼ãƒ 
        if (latlngs.length > 0) {
            this.state.map.fitBounds(L.latLngBounds(latlngs).pad(0.1));
        }
      },

      analyzePlant(nodeId) {
        this.state.selectedPlantId = nodeId;
        this.clearChainSelection(); // æ–°ã—ã„åˆ†ææ™‚ã¯ãƒ«ãƒ¼ãƒˆé¸æŠãƒªã‚»ãƒƒãƒˆ
        
        this.identifyRelatedNetwork(nodeId);
        this.updateVisibility();

        const targetMarker = this.state.markers[nodeId];
        if (targetMarker) {
           targetMarker.setStyle({ radius: 10, weight: 3, color: "#2d3748" });
           targetMarker.bringToFront();
        }

        const feature = (this.state.geoJsonData.features || []).find(f => f.properties.id === nodeId);
        if (!feature) return;

        const p = feature.properties;
        document.getElementById("analysis-company-strong").textContent = p.company;
        document.getElementById("plant-name-span").textContent = p.plant;
        const riskEl = document.getElementById("tierN-risk");
        riskEl.textContent = p.risklevel;
        riskEl.style.color = this.getRiskColor(p.risklevel);

        const upstream = new Set(this.state.upstreamData[String(nodeId)] || []);
        const downstream = new Set(this.state.downstreamData[String(nodeId)] || []);
        document.getElementById("upstream-count").textContent = upstream.size;
        document.getElementById("downstream-count").textContent = downstream.size;

        document.getElementById("analysis-info").classList.add("show");

        this.renderTier1List(nodeId);
        this.renderDownstreamList(nodeId);
        this.renderImpactedTier1s(nodeId);
        
        this.currentChainNodeId = nodeId;
        document.getElementById("tab-buttons").style.display = "flex";
      },
      
      identifyRelatedNetwork(startNodeId) {
          const related = new Set();
          related.add(Number(startNodeId));

          const qUp = [startNodeId];
          const visitedUp = new Set([startNodeId]);
          while(qUp.length > 0) {
              const curr = qUp.shift();
              const ups = this.state.upstreamData[String(curr)] || [];
              ups.forEach(next => {
                  const nId = Number(next);
                  if(!visitedUp.has(next)) {
                      visitedUp.add(next);
                      qUp.push(next);
                      related.add(nId);
                  }
              });
          }

          const qDown = [startNodeId];
          const visitedDown = new Set([startNodeId]);
          while(qDown.length > 0) {
              const curr = qDown.shift();
              const downs = this.state.downstreamData[String(curr)] || [];
              downs.forEach(next => {
                   const nId = Number(next);
                   if(!visitedDown.has(next)) {
                       visitedDown.add(next);
                       qDown.push(next);
                       related.add(nId);
                   }
              });
          }
          
          this.state.relatedNodeIds = related;
      },

      renderImpactedTier1s(nodeId) {
          const container = document.getElementById("contact-tier1-list");
          container.innerHTML = "";
          const section = document.getElementById("contact-tier1-section");
          section.classList.remove("show");
          
          // â˜…ä¿®æ­£: undefinedå›é¿ã®ãŸã‚ this.state.featureById ã‚’å‚ç…§
          const featureById = this.state.featureById;

          if (this.state.sanohTier1Set.has(Number(nodeId))) {
             this.renderList(container, [Number(nodeId)], "#e53e3e"); 
             section.classList.add("show");
             return;
          }

          const impactedTier1s = new Set();
          const queue = [nodeId];
          const visited = new Set();
          
          while(queue.length > 0) {
              const curr = queue.shift();
              if (visited.has(curr)) continue;
              visited.add(curr);

              const downstream = this.state.downstreamData[String(curr)] || [];
              
              downstream.forEach(next => {
                  if (this.state.sanohTier1Set.has(Number(next))) {
                      impactedTier1s.add(Number(next));
                  } else {
                      queue.push(next);
                  }
              });
          }

          if (impactedTier1s.size > 0) {
              this.renderList(container, Array.from(impactedTier1s), "#e53e3e");
              section.classList.add("show");
          }
      },

      renderTier1List(nodeId) {
        const container = document.getElementById("tier1-list");
        container.innerHTML = "";
        
        const upstreamIds = this.state.upstreamData[String(nodeId)] || [];
        const uniqIds = Array.from(new Set(upstreamIds.map(id => Number(id))));

        if (uniqIds.length === 0) {
          document.getElementById("tier1-section").classList.remove("show");
          return;
        }

        this.renderList(container, uniqIds, "#ecc94b");
        document.getElementById("tier1-section").classList.add("show");
      },

      renderDownstreamList(nodeId) {
        const container = document.getElementById("downstream-list");
        container.innerHTML = "";
        
        const downstreamIds = this.state.downstreamData[String(nodeId)] || [];
        const uniqIds = Array.from(new Set(downstreamIds.map(id => Number(id))));

        if (uniqIds.length === 0) {
          document.getElementById("downstream-section").classList.remove("show");
          return;
        }

        this.renderList(container, uniqIds, "#38a169");
        document.getElementById("downstream-section").classList.add("show");
      },

      renderList(container, ids, borderColor) {
        const featureById = this.state.featureById;

        const items = ids
          .map(id => featureById[id])
          .filter(Boolean)
          .sort((a,b) => (a.properties.company).localeCompare(b.properties.company, "ja"));

        items.forEach(f => { // â˜…ä¿®æ­£: itemsã®è¦ç´ ã¯Featureãªã®ã§ f ã¨ã™ã‚‹
          const p = f.properties; // â˜…ä¿®æ­£: Featureã‹ã‚‰Propertiesã‚’å–å¾—
          const div = document.createElement("div");
          div.className = "tier-item";
          div.style.borderLeftColor = borderColor;
          div.onclick = () => this.analyzePlant(p.id);
          const riskColor = this.getRiskColor(p.risklevel);
          div.innerHTML = `
            <div><div class="tier-company">${p.company}</div><div class="tier-plant">${p.plant}</div></div>
            <div class="tier-risk-tag" style="background:${riskColor};">${p.risklevel}</div>`;
          container.appendChild(div);
        });
      },

      // â˜… ä¿®æ­£: ç·šã®å¤ªã•ã‚’èª¿æ•´ (ãƒ«ãƒ¼ãƒˆé¸æŠæ™‚5pxã€å…¨ä½“è¡¨ç¤ºæ™‚2.5px)
      updateVisibility() {
        const getChecked = (id) => { const el = document.getElementById(id); return el ? el.checked : true; };
        const filters = {
          CRITICAL: getChecked("filter-marker-critical"),
          HIGH:     getChecked("filter-marker-high"),
          MEDIUM:   getChecked("filter-marker-medium"),
          LOW:      getChecked("filter-marker-low"),
        };
        const lFilters = {
          CRITICAL: getChecked("filter-link-critical"),
          HIGH:     getChecked("filter-link-high"),
          MEDIUM:   getChecked("filter-link-medium"),
          LOW:      getChecked("filter-link-low"),
        };

        const isAnalysisActive = this.state.selectedPlantId !== null;
        const activeChain = this.state.activeChainArray;
        const isRouteSelected = activeChain !== null; 
        
        let visibleM = 0;
        const activeSet = isRouteSelected ? new Set(activeChain.map(Number)) : null;

        // ãƒãƒ¼ã‚«ãƒ¼
        Object.entries(this.state.markers).forEach(([id, marker]) => {
           const f = (this.state.geoJsonData.features || []).find(feat => String(feat.properties.id) === String(id));
           if(!f) return;
           
           let show = filters[f.properties.risklevel] !== false;
           const numId = Number(id);

           if (activeSet) {
               if (!activeSet.has(numId)) show = false;
           } else if (isAnalysisActive) {
               if (!this.state.relatedNodeIds.has(numId)) show = false;
           }

           if(show) visibleM++;
           marker.setStyle({ opacity: show ? 1 : 0, fillOpacity: show ? 0.9 : 0, pointerEvents: show ? 'auto' : 'none' });
        });
        document.getElementById("stat-visible-markers").textContent = visibleM;

        // ãƒªãƒ³ã‚¯ (ãƒ«ãƒ¼ãƒˆé¸æŠä¸­ã¯ã€æ—¢å­˜ã®å…¨ãƒªãƒ³ã‚¯ã‚’éè¡¨ç¤ºã«ã—ã€routeLayerGroupã«ä»»ã›ã‚‹)
        ["CRITICAL","HIGH","MEDIUM","LOW"].forEach(risk => {
           const riskShow = lFilters[risk] !== false;
           
           this.state.links[risk].forEach(l => {
             let show = riskShow;
             let lineStyle = { ...CONFIG.LINK_STYLES[risk] }; 

             if (isRouteSelected) {
                 // ãƒ«ãƒ¼ãƒˆé¸æŠä¸­ã¯ã€èƒŒæ™¯ã®ãƒªãƒ³ã‚¯ã¯ã™ã¹ã¦æ¶ˆã™
                 show = false;
             } else if (isAnalysisActive) {
                 // é€šå¸¸åˆ†æãƒ¢ãƒ¼ãƒ‰ï¼šIDæƒ…å ±ãŒãªã„ãƒªãƒ³ã‚¯ã¯æ¶ˆã›ãªã„ã®ã§è–„ãã™ã‚‹
                 lineStyle.opacity = 0.1; 
                 lineStyle.weight = 1;
             } else {
                 // é€šå¸¸æ™‚
             }

             if (!show) lineStyle.opacity = 0;
             l.line.setStyle(lineStyle);
           });
        });
      },

      searchCompany() {
        const input = document.getElementById("search-company");
        const query = (input.value || "").trim().toLowerCase();
        if (!query) return;
        const features = this.state.geoJsonData.features || [];
        const matches = features.filter(f => (f.properties.company || "").toLowerCase().includes(query));
        if (matches.length === 0) { alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"); return; }
        this.state.companyPlants = matches.map(f => ({ id: f.properties.id, company: f.properties.company, plant: f.properties.plant, risk: f.properties.risklevel }));
        this.renderPlantList();
      },

      renderPlantList() {
        const container = document.getElementById("plant-list");
        const wrap = document.getElementById("plant-list-container");
        container.innerHTML = "";
        document.getElementById("plant-count").textContent = this.state.companyPlants.length;
        wrap.style.display = "block";
        const riskOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };
        const sorted = [...this.state.companyPlants].sort((a,b) => riskOrder[a.risk] - riskOrder[b.risk]);
        sorted.forEach(p => {
          const div = document.createElement("div");
          div.className = "plant-item";
          const color = this.getRiskColor(p.risk);
          div.innerHTML = `<div class="risk-badge" style="background:${color}"></div><div style="flex:1"><div style="font-weight:700; color:#2d3748;">${p.company}</div><div style="font-size:11px; color:#718096;">${p.plant}</div></div><div class="risk-badge-sm" style="background:${color}">${p.risk}</div>`;
          div.onclick = () => { this.analyzePlant(p.id); const m = this.state.markers[p.id]; if(m) this.state.map.setView(m.getLatLng(), 8); };
          container.appendChild(div);
        });
      },

      showSupplyChainTab(mode) {
         if(!this.currentChainNodeId) return;
         const flowTab = document.getElementById("flow-tab");
         const tableTab = document.getElementById("table-tab");
         const btns = document.querySelectorAll(".tab-btn");
         if(mode === 'flow') {
            flowTab.style.display = 'block'; tableTab.style.display = 'none';
            btns[0].classList.add("active"); btns[1].classList.remove("active");
         } else {
            flowTab.style.display = 'none'; tableTab.style.display = 'block';
            btns[0].classList.remove("active"); btns[1].classList.add("active");
         }
         this.buildSmartSupplyChain(this.currentChainNodeId);
      },

      buildSmartSupplyChain(nodeId) {
         const upstream = this.state.upstreamData[String(nodeId)] || [];
         const downstream = this.state.downstreamData[String(nodeId)] || [];
         
         let traceType = "upstream";
         let chains = [];

         if (upstream.length > 0) {
            traceType = "upstream (ä¾›çµ¦å…ƒã¸ã®é¡ã‚Š)";
            chains = this.traceChains(nodeId, "upstream");
         } 
         else if (downstream.length > 0) {
            traceType = "downstream (ä¾›çµ¦å…ˆã¸ã®è¿½è·¡)";
            chains = this.traceChains(nodeId, "downstream");
         }
         
         if (chains.length === 0) {
            alert("ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã®ã¤ãªãŒã‚ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            return;
         }
         
         this.state.currentChains = chains;
         this.state.currentTraceType = traceType;
         const feature = (this.state.geoJsonData.features || []).find(f => f.properties.id === nodeId);
         this.state.currentTargetName = feature ? `${feature.properties.company}_${feature.properties.plant}` : "analysis";

         document.getElementById("trace-direction-label").textContent = traceType;
         this.renderSupplyChainModal(nodeId, chains, traceType);
      },

      traceChains(startNodeId, direction) {
         const maxDepth = 10;
         const chains = [];
         const queue = [{ path: [startNodeId], depth: 0 }];
         const data = direction === "upstream" ? this.state.upstreamData : this.state.downstreamData;

         while(queue.length) {
            const { path, depth } = queue.shift();
            if (depth >= maxDepth) continue;
            
            const curr = path[path.length - 1];
            
            const feature = (this.state.geoJsonData.features || []).find(f => String(f.properties.id) === String(curr));
            const isSanoh = feature && feature.properties.company.includes("ä¸‰æ¡œå·¥æ¥­");
            const isTier1 = this.state.sanohTier1Set.has(Number(curr));

            if (isSanoh || isTier1) {
                chains.push(path);
                continue;
            }

            const nextNodes = data[String(curr)] || [];
            
            if (nextNodes.length === 0) {
               continue; 
            }

            nextNodes.forEach(next => {
               if(path.includes(next)) return; 
               queue.push({ path: [...path, next], depth: depth + 1 });
            });
         }
         return chains;
      },
      
      downloadCSV() {
        if (!this.state.currentChains || !this.state.currentChains.length) {
            alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        const featureById = {};
        (this.state.geoJsonData.features || []).forEach(f => featureById[f.properties.id] = f.properties);

        let csvContent = "\uFEFF";
        csvContent += "Chain_ID,Sequence,Tier,Company,Plant,Risk_Level\n";

        this.state.currentChains.forEach((path, idx) => {
            const displayPath = this.state.currentTraceType.includes("upstream") ? [...path].reverse() : path;
            
            displayPath.forEach((nodeId, i) => {
                const p = featureById[nodeId];
                if (!p) return;
                
                const company = p.company ? p.company.replace(/"/g, '""') : "";
                const plant = p.plant ? p.plant.replace(/"/g, '""') : "";
                const tierLevel = (displayPath.length - 1) - i;
                
                csvContent += `${idx + 1},${i + 1},Tier ${tierLevel},"${company}","${plant}",${p.risklevel}\n`;
            });
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        const now = new Date();
        const timeStr = `${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}`;
        const fileName = `SupplyChain_${this.state.currentTargetName}_${timeStr}.csv`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },

      renderSupplyChainModal(targetId, chains, traceType) {
         const featureById = {};
         (this.state.geoJsonData.features || []).forEach(f => featureById[f.properties.id] = f.properties);
         const target = featureById[targetId];

         document.getElementById("sc-title-span").textContent = `${target.company} ${target.plant}`;
         
         const flowRoot = document.getElementById("flow-chains");
         const tableRoot = document.getElementById("table-chains");
         flowRoot.innerHTML = "";
         tableRoot.innerHTML = "";

         chains.forEach((path, idx) => {
            const div = document.createElement("div");
            div.className = "chain-item";
            const header = document.createElement("div");
            header.className = "chain-header";
            
            const num = document.createElement("div");
            num.className = "chain-number";
            num.textContent = `ãƒ«ãƒ¼ãƒˆ ${idx + 1}`;
            
            const btnMap = document.createElement("button");
            btnMap.className = "btn-map-view";
            btnMap.textContent = "ğŸ—ºï¸ ã“ã®ãƒ«ãƒ¼ãƒˆã‚’åœ°å›³è¡¨ç¤º";
            btnMap.onclick = () => this.showChainOnMap(idx);
            
            header.appendChild(num);
            header.appendChild(btnMap);
            div.appendChild(header);

            const diagram = document.createElement("div");
            diagram.className = "flow-diagram";
            
            const displayPath = traceType.includes("upstream") ? [...path].reverse() : path;

            displayPath.forEach((id, i) => {
               const p = featureById[id];
               if(!p) return;
               
               const node = document.createElement("div");
               node.className = "flow-node";
               
               const isTarget = String(p.id) === String(targetId);
               const riskClass = p.risklevel === 'CRITICAL' ? 'risk-critical' :
                                 p.risklevel === 'HIGH' ? 'risk-high' :
                                 p.risklevel === 'MEDIUM' ? 'risk-medium' : 'risk-low';

               node.innerHTML = `
                  <div class="flow-box ${isTarget ? 'target' : ''}">${p.company}</div>
                  <div class="flow-company">${p.plant}</div>
                  <div class="risk-badge-sm ${riskClass}" style="margin-top:2px;">${p.risklevel}</div>
               `;
               diagram.appendChild(node);

               if (i < displayPath.length - 1) {
                  const arrow = document.createElement("div");
                  arrow.className = "flow-arrow";
                  arrow.innerHTML = "â¡";
                  diagram.appendChild(arrow);
               }
            });
            div.appendChild(diagram);
            flowRoot.appendChild(div);
         });
         
         const tableHtml = [];
         chains.forEach((path, idx) => {
             tableHtml.push(`<div class="chain-item"><div class="chain-number">ãƒ«ãƒ¼ãƒˆ ${idx+1}</div>`);
             tableHtml.push(`<table style="width:100%; border-collapse:collapse; font-size:11px;">`);
             tableHtml.push(`<thead style="background:#edf2f7; text-align:left;"><tr><th style="padding:6px;">éšå±¤ (Tier)</th><th>ä¼æ¥­</th><th>æ‹ ç‚¹</th><th>ãƒªã‚¹ã‚¯</th></tr></thead><tbody>`);
             
             const displayPath = traceType.includes("upstream") ? [...path].reverse() : path;

             displayPath.forEach((id, i) => {
                const p = featureById[id];
                if(!p) return;
                
                const tierLevel = (displayPath.length - 1) - i;
                const levelLabel = tierLevel === 0 ? "Tier 0 (è‡ªç¤¾/Tier1)" : `Tier ${tierLevel}`;
                
                tableHtml.push(`<tr style="border-bottom:1px solid #eee;">`);
                tableHtml.push(`<td style="padding:6px; font-weight:700; color:#5a67d8;">${levelLabel}</td>`);
                tableHtml.push(`<td>${p.company}</td><td>${p.plant}</td>`);
                tableHtml.push(`<td><span class="risk-badge-sm" style="background:${this.getRiskColor(p.risklevel)}">${p.risklevel}</span></td>`);
                tableHtml.push(`</tr>`);
             });
             tableHtml.push(`</tbody></table></div>`);
         });
         tableRoot.innerHTML = tableHtml.join("");

         document.getElementById("supply-chain-viewer").classList.add("show");
      },

      closeSupplyChainViewer() {
         document.getElementById("supply-chain-viewer").classList.remove("show");
      }
    };

    window.addEventListener("load", () => {
      app.initData();
    });
  </script>
</body>
</html>
